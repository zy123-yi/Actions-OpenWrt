name: OpenWrt Builder 2026-Pro

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  BUILD_DIR: /mnt/openwrt 

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Initialization Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libglib2.0-dev libltdl-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev pcre2-utils libunistring-dev libxml2-utils libzstd-dev libelf-dev
          sudo timedatectl set-timezone "Asia/Shanghai"
          sudo mkdir -p ${{ env.BUILD_DIR }}
          sudo chown $USER:$GROUPS ${{ env.BUILD_DIR }}

      - name: Clone Source Code
        run: |
          git clone $REPO_URL -b $REPO_BRANCH ${{ env.BUILD_DIR }}
          ln -sf ${{ env.BUILD_DIR }} $GITHUB_WORKSPACE/openwrt

      - name: Load Custom Feeds
        run: |
          cd ${{ env.BUILD_DIR }}
          [ -f $GITHUB_WORKSPACE/$FEEDS_CONF ] && cp $GITHUB_WORKSPACE/$FEEDS_CONF ./feeds.conf.default
          if [ -f $GITHUB_WORKSPACE/$DIY_P1_SH ]; then
            chmod +x $GITHUB_WORKSPACE/$DIY_P1_SH
            $GITHUB_WORKSPACE/$DIY_P1_SH
          fi
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load Custom Configuration
        run: |
          cd ${{ env.BUILD_DIR }}
          [ -f $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE .config || make defconfig
          
          # 1. 彻底禁用导致报错的内核模块 (强制同步配置)
          sed -i '/CONFIG_PACKAGE_kmod-cryptodev/d' .config
          echo "CONFIG_PACKAGE_kmod-cryptodev=n" >> .config
          echo "CONFIG_OPENSSL_ENGINE_BUILTIN_DEVCRYPTO=n" >> .config
          
          # 2. 针对 sing-box 的“减负”处理
          # 改为模块(m)可大幅降低最后打包时的 rootfs 溢出风险
          sed -i 's/CONFIG_PACKAGE_sing-box=y/CONFIG_PACKAGE_sing-box=m/g' .config
          
          if [ -f $GITHUB_WORKSPACE/$DIY_P2_SH ]; then
            chmod +x $GITHUB_WORKSPACE/$DIY_P2_SH
            $GITHUB_WORKSPACE/$DIY_P2_SH
          fi
          
          make defconfig

      # 7. 专项分段编译 (2026 最终加固版)
      - name: Multi-Stage Compilation
        run: |
          cd /workdir/openwrt
          
          # 1. 容错环境变量
          export CFLAGS="-O2 -Wno-error=all -Wno-unused-result"
          export CXXFLAGS="-O2 -Wno-error=all -Wno-unused-result"
          export FORCE_UNSAFE_CONFIGURE=1
          
          # 2. 预检下载：彻底清理损坏的内核和库文件
          echo "::group::Step 0 - Smart Download"
          mkdir -p dl
          # 物理删除所有可能导致 Hash 报错的小于 1k 的残缺包
          find dl -size -1k -name "*.tar.*" -delete
          # 针对性清理经常损坏的包
          rm -f dl/linux-6.12* dl/musl-* dl/gcc-*
          
          # 强制手动预下载核心内核包（防止 OpenWrt 脚本下载器抽风）
          wget -T 60 -t 5 -P dl/ https://sources.openwrt.org/linux-6.12.69.tar.xz || echo "备用源下载"
          
          make download -j$(nproc) WGET="wget --timeout=60 --tries=5" || make download -j1 V=s
          echo "::endgroup::"

          # 3. 工具链编译：这是地基，报错必须重试
          echo "::group::Step 1 - Tools & Toolchain"
          # Tools 通常很稳
          make tools/install -j$(nproc) || make tools/install -j1 V=s
          
          # Toolchain 报错则清理后单线程重来，这是解决 gcc-final 错误的关键
          make toolchain/install -j$(nproc) || {
              echo "检测到工具链编译失败，正在尝试单线程修复..."
              make toolchain/gcc/initial/clean
              make toolchain/musl/clean
              make toolchain/install -j1 V=s
          }
          echo "::endgroup::"

          # 4. 内核准备
          echo "::group::Step 2 - Target & Linux Preparation"
          make target/linux/compile -j$(nproc) || make target/linux/compile -j1 V=s
          echo "::endgroup::"

          # 5. 插件编译：开启空间回收
          echo "::group::Step 3 - Package Compilation"
          # 针对 sing-box 等 Go 大户，限制并发防止 OOM 内存溢出
          make package/compile -j$(nproc) IGNORE_ERRORS=m || make package/compile -j1 V=s IGNORE_ERRORS=m
          # 编译完插件立即删除 dl 释放空间给最后的打包
          rm -rf dl
          echo "::endgroup::"

          # 6. 镜像生成：最后的路径校验
          echo "::group::Step 4 - Image Build"
          if [ -d "build_dir/target-x86_64_musl/root-x86" ]; then
              make target/install -j$(nproc) || make target/install -j1 V=s
          else
              echo "致命错误：root-x86 目录未生成，工具链或内核编译存在残留问题！"
              df -h
              exit 1
          fi
          echo "::endgroup::"

      - name: Organize Files
        run: |
          mkdir -p $GITHUB_WORKSPACE/outputs
          cd ${{ env.BUILD_DIR }}/bin/targets/*/*
          # 移动主镜像
          cp -f *-combined-efi.img.gz $GITHUB_WORKSPACE/outputs/ || true
          # 移动刚才模块编译生成的 sing-box ipk (方便手动安装)
          find ${{ env.BUILD_DIR }}/bin/packages/x86_64/ -name "sing-box*.ipk" -exec cp {} $GITHUB_WORKSPACE/outputs/ \;
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        if: env.UPLOAD_RELEASE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: OpenWrt_x86_64_${{ github.run_id }}
          files: $GITHUB_WORKSPACE/outputs/*
