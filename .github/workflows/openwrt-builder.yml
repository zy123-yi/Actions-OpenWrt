name: OpenWrt Builder 2026-Pro

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    # 升级到最新的 Ubuntu 22.04
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space
        run: |
          # 增加对 Azure 预装大文件的清理
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache /usr/local/share/boost /usr/lib/jvm
          # 彻底清理 Docker 冗余
          sudo docker image prune --all --force
          # 清理 apt 缓存
          sudo apt-get clean
          df -h

      - name: Initialization Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          # 补充 libzstd-dev (加速内核) 和 libelf-dev (6.12内核必须)
          sudo apt-get install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libglib2.0-dev libltdl-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev pcre2-utils libunistring-dev libxml2-utils libzstd-dev libelf-dev
          
          # 性能补丁：增加 Swap 空间，防止多线程编译内存崩溃
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Space Great Migration
        run: |
          # 1. 在空间充裕的 /mnt 创建实际的编译目录
          sudo mkdir -p /mnt/workdir/openwrt
          sudo chown $USER:$GROUPS /mnt/workdir/openwrt
          
          # 2. 关键修复：确保 /workdir 目录本身存在
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

          # 3. 执行软链接
          ln -sf /mnt/workdir/openwrt /workdir/openwrt
          
          # 4. 验证路径
          ls -ld /workdir/openwrt
          df -h
          
      # 4. 源码拉取
      - name: Clone Source Code
        working-directory: /workdir
        run: |
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      # 5. 执行 DIY1 与 Feeds 更新
      - name: Load Custom Feeds
        run: |
          cd /workdir/openwrt
          # 修正路径：直接使用代码库中的文件
          [ -f $GITHUB_WORKSPACE/$FEEDS_CONF ] && mv $GITHUB_WORKSPACE/$FEEDS_CONF ./feeds.conf.default
          if [ -f $GITHUB_WORKSPACE/$DIY_P1_SH ]; then
            chmod +x $GITHUB_WORKSPACE/$DIY_P1_SH
            $GITHUB_WORKSPACE/$DIY_P1_SH
          fi
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 6. 配置加载与“安全第一”固化
      - name: Load Custom Configuration
        run: |
          cd /workdir/openwrt
          # 优先级：1. 仓库内 config > 2. 默认 config
          [ -f $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE .config || make defconfig
          
          # A. 彻底剔除不稳定的组件 (防止编译中断)
          # 去除 Shadowsocks-Rust
          sed -i 's/CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Client=y/CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Client=n/g' .config
          sed -i 's/CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Server=y/CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Server=n/g' .config
          
          # B. 暴力剔除 cryptodev (核心修复)
          # 1. 在 config 中禁用
          sed -i '/CONFIG_PACKAGE_kmod-cryptodev/d' .config
          echo "CONFIG_PACKAGE_kmod-cryptodev=n" >> .config
          # 2. 直接物理删除源码目录，彻底断绝依赖关联
          rm -rf package/kernel/cryptodev-linux
          
          # C. 强化 Unbound 核心依赖
          echo "CONFIG_PACKAGE_unbound-anchor=y" >> .config
          echo "CONFIG_PACKAGE_unbound-control=y" >> .config
          
          # 执行 DIY-Part2 脚本
          if [ -f $GITHUB_WORKSPACE/$DIY_P2_SH ]; then
            chmod +x $GITHUB_WORKSPACE/$DIY_P2_SH
            $GITHUB_WORKSPACE/$DIY_P2_SH
          fi
          
          # 刷新配置
          make defconfig

      # 7. 专项分段编译 (2026 增强版)
      - name: Multi-Stage Compilation
        run: |
          cd /workdir/openwrt
          
          # 1. 注入容错环境变量
          export CFLAGS="-O2 -Wno-error=all -Wno-unused-result"
          export CXXFLAGS="-O2 -Wno-error=all -Wno-unused-result"
          export FORCE_UNSAFE_CONFIGURE=1
          
          # 2. 预检下载 (带超时重试)
          echo "::group::Step 0 - Smart Download"
          mkdir -p dl
          find dl -size -1k -name "*.tar.*" -exec rm -f {} \;
          make download -j$(nproc) WGET="wget --timeout=30 --tries=3" || make download -j1 V=s
          echo "::endgroup::"

          # 3. 工具链编译
          echo "::group::Step 1 - Tools & Toolchain"
          make tools/install -j$(nproc) || make tools/install -j1 V=s
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s
          echo "::endgroup::"

          # 4. 内核准备 (先于插件编译，确保内核模块环境就绪)
          echo "::group::Step 2 - Target & Linux Preparation"
          make target/linux/compile -j$(nproc) || make target/linux/compile -j1 V=s
          echo "::endgroup::"

          # 5. 插件编译 (忽略非核心错误，保障流程继续)
          echo "::group::Step 3 - Package Compilation"
          # 编译完成后删除 dl 目录以释放 2-4GB 磁盘空间，供后续打包使用
          make package/compile -j$(nproc) IGNORE_ERRORS=m || make package/compile -j1 V=s IGNORE_ERRORS=m
          rm -rf dl 
          echo "::endgroup::"

          # 6. 镜像生成 (增加路径校验)
          echo "::group::Step 4 - Image Build"
          # 检查 rootfs 目录是否存在，防止 mksquashfs 报错
          if [ -d "build_dir/target-x86_64_musl/root-x86" ]; then
              echo "RootFS directory exists. Starting image packaging..."
              make target/install -j$(nproc) || make target/install -j1 V=s
          else
              echo "Error: root-x86 directory missing! Compilation failed in previous steps."
              df -h
              exit 1
          fi
          echo "::endgroup::"
          
      # 8. 产物整理与发布
      - name: Organize Files
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        if: env.UPLOAD_RELEASE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: OpenWrt_x86_64_${{ github.run_id }}
          files: ${{ env.FIRMWARE }}/*
