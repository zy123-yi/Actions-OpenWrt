name: OpenWrt Builder 2026-Pro

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    # 升级到最新的 Ubuntu 24.04
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 极端扩容：必须放在最前面，且增加删除项
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Cleanup and Re-partition
        run: |
          # 1. 删除所有不必要的预装大型软件
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache /usr/local/share/boost /usr/lib/jvm
          
          # 2. 彻底清理 Docker
          sudo docker image prune --all --force
          
          # 3. 关键：将临时目录指向更大的磁盘空间
          # GitHub Actions 的工作目录是在 /home/runner/work，这里空间相对较大
          sudo mkdir -p /home/runner/work/tmp
          sudo chmod 1777 /home/runner/work/tmp
          echo "TMPDIR=/home/runner/work/tmp" >> $GITHUB_ENV
          
          # 4. 检查磁盘
          df -h
          

      # 2. 物理腾空间：在 apt 运行前，手动清理掉由于重挂载可能残留的大文件
      - name: Physical Cleanup
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache /usr/local/share/boost
          # 检查磁盘空间，确保根目录有足够的余量
          df -h

      # 3. 环境初始化（现在有空间运行 apt-get 了）
      - name: Initialization Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # 在最前面增加空间检查逻辑
          sudo mkdir -p /mnt/workdir
          sudo chown $USER:$GROUPS /mnt/workdir
          sudo -E apt-get -qq update
          # 安装核心依赖
          sudo -E apt-get -qq install --no-install-recommends \
            build-essential libgmp-dev libmpfr-dev libmpc-dev libelf-dev \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison bzip2 ccache cmake cpio \
            curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man \
            intltool libc6-dev-i386 libglib2.0-dev libltdl-dev libncurses5-dev libncursesw5-dev \
            libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full \
            patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools \
            subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev pcre2-utils \
            libunistring-dev libxml2-utils
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          # 准备编译工作区
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          # ... 安装命令 ...
          sudo ln -sf /usr/bin/python3 /usr/bin/python
          # 关键：修复 Ubuntu 24.04 可能缺失的某些底层兼容头文件
          sudo apt-get install -y lib32gcc-s1 lib32stdc++6

      # 4. 源码拉取
      - name: Clone Source Code
        working-directory: /workdir
        run: |
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      # 5. 执行 DIY1 与 Feeds 更新
      - name: Load Custom Feeds
        run: |
          cd /workdir/openwrt
          [ -f /tmp/feeds_conf ] && mv /tmp/feeds_conf ./feeds.conf.default
          if [ -f /tmp/diy-part1.sh ]; then
            chmod +x /tmp/diy-part1.sh
            /tmp/diy-part1.sh
          fi
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 6. 配置加载与“去 Rust”固化
      - name: Load Custom Configuration
        run: |
          cd /workdir/openwrt
          [ -f /tmp/config_base ] && mv /tmp/config_base .config || make defconfig
          # 彻底移除 Shadowsocks-Rust 及其导致的冲突
          sed -i 's/CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Client=y/CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Client=n/g' .config
          sed -i 's/CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Server=y/CONFIG_PACKAGE_luci-app-ssr-plus_INCLUDE_Shadowsocks_Rust_Server=n/g' .config
          if [ -f /tmp/diy-part2.sh ]; then
            chmod +x /tmp/diy-part2.sh
            /tmp/diy-part2.sh
          fi
          make defconfig

      # 7. 专项分段编译 (完整版：工具链 -> 插件 -> 镜像)
      - name: Multi-Stage Compilation
        run: |
          cd /workdir/openwrt
          export CFLAGS="-O2 -Wno-error=all"
          export CXXFLAGS="-O2 -Wno-error=all"
          make defconfig
          
          echo "::group::Step 1 - Tools Build"
          make tools/install -j$(nproc) || make tools/install -j1 V=s
          echo "::endgroup::"

          echo "::group::Step 2 - Toolchain Build"
          # 包含 binutils, gcc-initial, kernel-headers, gcc-final 等
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s
          echo "::endgroup::"

          echo "::group::Step 3 - Package Build"
          # 下载源码包
          make download -j16
          # 编译所有插件。IGNORE_ERRORS=1 防止个别非核心插件报错导致流程中断
          make package/compile -j$(nproc) IGNORE_ERRORS=1 || make package/compile -j1 V=s IGNORE_ERRORS=1
          echo "::endgroup::"

          echo "::group::Step 4 - Final Image Build"
          # 这步才是真正的“打包固件”，生成最终的镜像文件
          make target/install -j$(nproc) || make target/install -j1 V=s
          echo "::endgroup::"

      # 8. 产物整理与发布
      - name: Organize Files
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        if: env.UPLOAD_RELEASE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: OpenWrt_x86_64_${{ github.run_id }}
          files: ${{ env.FIRMWARE }}/*
