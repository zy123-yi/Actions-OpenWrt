name: OpenWrt Builder 2026-Pro

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  BUILD_DIR: openwrt 

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Load Custom Configuration
        run: |
          cd $GITHUB_WORKSPACE/${{ env.BUILD_DIR }}
          [ -f $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE .config || make defconfig
          
          # 1. 基础组件剔除 (Docker, Python, Node)
          sed -i '/CONFIG_PACKAGE_docker/d' .config
          sed -i '/CONFIG_PACKAGE_luci-app-dockerman/d' .config
          sed -i '/CONFIG_PACKAGE_python3/d' .config
          sed -i '/CONFIG_PACKAGE_node/d' .config
          echo -e "\nCONFIG_PACKAGE_luci-app-dockerman=n\nCONFIG_PACKAGE_python3=n\nCONFIG_PACKAGE_node=n" >> .config

          # 2. 【核心修复】使用变量注入而非物理破坏 (解决 Error 255)
          # 在 .config 中彻底禁用
          sed -i '/CONFIG_PACKAGE_libopenssl_devcrypto/d' .config
          sed -i '/CONFIG_PACKAGE_libopenssl_engine/d' .config
          echo -e "CONFIG_PACKAGE_libopenssl_devcrypto=n\nCONFIG_PACKAGE_libopenssl_engine=n" >> .config
          
          # 直接在 OpenSSL 的编译配置里增加强制宏定义，不再 sed 删除 enable-devcrypto
          # 这种方式最安全，不会破坏 Makefile 结构
          echo "OPENSSL_OPTIONS += no-devcrypto no-afalgeng" >> package/libs/openssl/Makefile

          # 3. 插件与内核优化 (SSR-Plus & PassWall 兼容性)
          sed -i 's/_INCLUDE_Shadowsocks_Rust_Client=y/_INCLUDE_Shadowsocks_Rust_Client=n/g' .config
          sed -i 's/_INCLUDE_Shadowsocks_Rust_Server=y/_INCLUDE_Shadowsocks_Rust_Server=n/g' .config
          sed -i '/CONFIG_PACKAGE_kmod-cryptodev/d' .config
          echo "CONFIG_PACKAGE_kmod-cryptodev=n" >> .config
          rm -rf package/kernel/cryptodev-linux

          # 4. 执行 DIY2 脚本
          if [ -f $GITHUB_WORKSPACE/$DIY_P2_SH ]; then
            chmod +x $GITHUB_WORKSPACE/$DIY_P2_SH
            $GITHUB_WORKSPACE/$DIY_P2_SH
          fi
          
          # 5. 刷新配置
          make defconfig
          
      - name: Clone Source Code
        run: |
          cd $GITHUB_WORKSPACE
          git clone $REPO_URL -b $REPO_BRANCH ${{ env.BUILD_DIR }}

      - name: Load Custom Feeds
        run: |
          cd $GITHUB_WORKSPACE/${{ env.BUILD_DIR }}
          [ -f $GITHUB_WORKSPACE/$FEEDS_CONF ] && cp $GITHUB_WORKSPACE/$FEEDS_CONF ./feeds.conf.default
          if [ -f $GITHUB_WORKSPACE/$DIY_P1_SH ]; then
            chmod +x $GITHUB_WORKSPACE/$DIY_P1_SH
            $GITHUB_WORKSPACE/$DIY_P1_SH
          fi
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load Custom Configuration
        run: |
          cd $GITHUB_WORKSPACE/${{ env.BUILD_DIR }}
          [ -f $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE .config || make defconfig
          
          # 1. 彻底剔除大户组件 (Docker, Python, Node, PHP)
          sed -i '/CONFIG_PACKAGE_docker/d' .config
          sed -i '/CONFIG_PACKAGE_luci-app-dockerman/d' .config
          sed -i '/CONFIG_PACKAGE_python3/d' .config
          sed -i '/CONFIG_PACKAGE_node/d' .config
          sed -i '/CONFIG_PACKAGE_php/d' .config
          echo -e "\nCONFIG_PACKAGE_luci-app-dockerman=n\nCONFIG_PACKAGE_python3=n\nCONFIG_PACKAGE_node=n" >> .config

          # 2. 【核心修复】强制 OpenSSL 放弃编译 devcrypto (OpenSSL 3.x 加固)
          # 直接修改 Makefile 禁止 enable-devcrypto 传参，并强制开启 NO_DEVCRYPTO 宏
          sed -i 's/enable-devcrypto//g' package/libs/openssl/Makefile
          echo "::group::Step 3 - Package Compilation"
          # 必须清理掉上次配置错误的目录，否则它会跳过配置阶段直接报错
          rm -rf build_dir/target-x86_64_musl/openssl-3.6.1
          make package/libs/openssl/compile V=s -j1 # 建议先让 OpenSSL 单独过关
          
          make package/compile -j$(nproc) IGNORE_ERRORS=m || make package/compile -j1 V=s IGNORE_ERRORS=m
          rm -rf dl
          echo "::endgroup::"

      - name: Multi-Stage Compilation
        run: |
          cd $GITHUB_WORKSPACE/${{ env.BUILD_DIR }}
          export FORCE_UNSAFE_CONFIGURE=1
          
          # 保护 2GB 根目录：重定向 Go 缓存
          export GOCACHE=$GITHUB_WORKSPACE/${{ env.BUILD_DIR }}/.gocache
          export GOPATH=$GITHUB_WORKSPACE/${{ env.BUILD_DIR }}/.gopath
          mkdir -p $GOCACHE $GOPATH
          
          echo "::group::Step 0 - Smart Download"
          mkdir -p dl
          find dl -size -1k -name "*.tar.*" -delete
          wget -T 60 -t 5 -P dl/ https://sources.openwrt.org/linux-6.12.69.tar.xz || echo "Kernel download bypass"
          make download -j$(nproc) || make download -j1 V=s
          echo "::endgroup::"

          echo "::group::Step 1 - Tools & Toolchain"
          make tools/install -j$(nproc) || make tools/install -j1 V=s
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s
          echo "::endgroup::"

          echo "::group::Step 2 - Target & Linux Preparation"
          make target/linux/compile -j$(nproc)
          echo "::endgroup::"

          echo "::group::Step 3 - Package Compilation"
          # 必须清理掉上次配置错误的目录，否则它会跳过配置阶段直接报错
          rm -rf build_dir/target-x86_64_musl/openssl-3.6.1
          make package/libs/openssl/compile V=s -j1 # 建议先让 OpenSSL 单独过关
          
          make package/compile -j$(nproc) IGNORE_ERRORS=m || make package/compile -j1 V=s IGNORE_ERRORS=m
          rm -rf dl
          echo "::endgroup::"
          
          echo "::group::Step 4 - Image Build"
          make target/install -j$(nproc) || make target/install -j1 V=s
          echo "::endgroup::"

      - name: Organize Files
        run: |
          mkdir -p $GITHUB_WORKSPACE/outputs
          cd $GITHUB_WORKSPACE/${{ env.BUILD_DIR }}
          TARGET_FILE=$(find bin/targets/ -name "*-combined-efi.img.gz" | head -n 1)
          if [ -n "$TARGET_FILE" ]; then
            cp -f $TARGET_FILE $GITHUB_WORKSPACE/outputs/
          fi
          find bin/packages/ -name "sing-box*.ipk" -exec cp {} $GITHUB_WORKSPACE/outputs/ \;
          echo "RELEASE_TAG=OpenWrt_x86_64_$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        if: env.UPLOAD_RELEASE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: $GITHUB_WORKSPACE/outputs/*
